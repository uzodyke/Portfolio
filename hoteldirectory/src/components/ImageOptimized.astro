---
export interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  loading?: 'lazy' | 'eager';
  decoding?: 'async' | 'sync' | 'auto';
  class?: string;
  sizes?: string;
  priority?: boolean;
}

const {
  src,
  alt,
  width = 800,
  height = 500,
  loading = 'lazy',
  decoding = 'async',
  class: className = '',
  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
  priority = false
} = Astro.props;

// Generate responsive image URLs for Google Images
const generateSrcSet = (originalSrc: string) => {
  if (!originalSrc.includes('googleusercontent.com')) {
    return '';
  }

  // Generate different sizes for responsive images
  const sizes = [400, 600, 800, 1200, 1600];
  return sizes
    .map(size => {
      const responsiveSrc = originalSrc.replace(/=w\d+-h\d+/, `=w${size}-h${Math.round(size * 0.6)}`);
      return `${responsiveSrc} ${size}w`;
    })
    .join(', ');
};

const srcSet = generateSrcSet(src);
const optimizedSrc = src.includes('googleusercontent.com')
  ? src.replace(/=w\d+-h\d+/, `=w${width}-h${height}`)
  : src;

// Preload critical images
const shouldPreload = priority || loading === 'eager';
---

{shouldPreload && (
  <link rel="preload" as="image" href={optimizedSrc} />
)}

<img
  src={optimizedSrc}
  srcset={srcSet}
  sizes={sizes}
  alt={alt}
  width={width}
  height={height}
  loading={loading}
  decoding={decoding}
  class={`lazy-image ${className}`}
  onload="this.classList.add('loaded')"
  onerror="this.src='/placeholder-hotel.jpg'; this.classList.add('loaded');"
/>

<style>
  .lazy-image {
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    background-color: #f3f4f6;
  }

  .lazy-image.loaded {
    opacity: 1;
  }

  .lazy-image[loading="eager"] {
    opacity: 1;
  }
</style>